{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Shopline Customers Portal{% endblock %}</title>
  <style>
    :root {
      --bg: #f4f4f5;
      --panel: #fff;
      --border: #e4e4e7;
      --text: #18181b;
      --text-muted: #71717a;
      --primary: #18181b;
      --link: #2563eb;
      --link-hover: #1d4ed8;
    }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); line-height: 1.5; }
    .portal-header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .portal-header h1 { font-size: 1.125rem; font-weight: 600; margin: 0; }
    .portal-header a { color: var(--link); text-decoration: none; }
    .portal-header a:hover { color: var(--link-hover); }
    .portal-nav { display: flex; gap: 1rem; align-items: center; }
    .portal-body { padding: 1.5rem; max-width: 1200px; margin: 0 auto; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { font-weight: 600; background: var(--bg); font-size: 0.875rem; }
    tr:last-child td { border-bottom: none; }
    .muted { color: var(--text-muted); font-size: 0.875rem; }
    .badge { display: inline-block; padding: 0.2em 0.5em; border-radius: 4px; font-size: 0.75rem; }
    .badge-member { background: #dcfce7; color: #166534; }
    .badge-not-member { background: #fef3c7; color: #92400e; }
    .pagination { margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .pagination a, .pagination span { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; text-decoration: none; color: var(--text); background: var(--panel); }
    .pagination a:hover { background: var(--bg); }
    .pagination .current { font-weight: 600; }
    .filters { margin-bottom: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; }
    .filters input, .filters select { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; }
    .filters button { padding: 0.5rem 1rem; background: var(--primary); color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .filters button:hover { opacity: 0.9; }
    .error-box { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; padding: 1rem; border-radius: 6px; margin: 1rem 0; }
    .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .detail-section { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; }
    .detail-section h3 { margin: 0 0 0.75rem; font-size: 0.875rem; color: var(--text-muted); text-transform: uppercase; }
    .detail-row { display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--border); font-size: 0.875rem; }
    .detail-row:last-child { border-bottom: none; }
  </style>
  {% block extra_css %}{% endblock %}
</head>
<body>
  <header class="portal-header">
    <h1>Shopline Customers Portal</h1>
    <nav class="portal-nav">
      <a href="{% url 'shopline_customers:customer_list' %}">Customers</a>
      <a href="/admin/">Django Admin</a>
      <a href="/admin/logout/">Logout</a>
    </nav>
  </header>
  <main class="portal-body">
    {% block content %}{% endblock %}
  </main>
  <div id="customer-modal-backdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:40;">
    <div id="customer-modal" style="max-width:520px;margin:5% auto;background:#fff;border-radius:6px;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,0.12);">
      <div style="padding:0.75rem 1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
        <strong id="customer-modal-title">Member</strong>
        <button type="button" id="customer-modal-close" style="border:none;background:transparent;font-size:1.1rem;cursor:pointer;">×</button>
      </div>
      <div id="customer-modal-body" style="padding:1rem;font-size:0.9rem;">
        Loading…
      </div>
    </div>
  </div>
  <script>
    (function () {
      const backdrop = document.getElementById("customer-modal-backdrop");
      const body = document.getElementById("customer-modal-body");
      const title = document.getElementById("customer-modal-title");
      const closeBtn = document.getElementById("customer-modal-close");
      if (!backdrop || !body || !title || !closeBtn) return;

      function closeModal() {
        backdrop.style.display = "none";
      }
      closeBtn.addEventListener("click", closeModal);
      backdrop.addEventListener("click", function (e) {
        if (e.target === backdrop) closeModal();
      });

      function renderContent(data) {
        if (!data.ok) {
          body.innerHTML = "<p style='color:#b91c1c;'>" + (data.error || "Failed to load member info.") + "</p>";
          return;
        }
        title.textContent = data.name || data.email || data.id || "Member";
        const tags = (data.tags || []).map(function (t) {
          return "<span style='display:inline-block;padding:0.15em 0.45em;margin:0 0.25em 0.25em 0;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:0.75rem;'>" +
                 String(t) + "</span>";
        }).join("");

        const coupons = (data.coupon_items || []).slice(0, 10).map(function (c) {
          const name = (c.name_translations && Object.values(c.name_translations)[0]) || c.name || "";
          const code = c.code || c.coupon_code || "";
          const status = c.status || "";
          return "<li><strong>" + (name || code || "Coupon") + "</strong>" +
                 (code ? " <span class='muted'>(" + code + ")</span>" : "") +
                 (status ? " – <span class='muted'>" + status + "</span>" : "") +
                 "</li>";
        }).join("");

        body.innerHTML =
          "<div class='detail-section' style='border:none;padding:0;'>" +
            "<div class='detail-row'><span>Email</span><span>" + (data.email || "—") + "</span></div>" +
            "<div class='detail-row'><span>Membership tier</span><span>" + (data.membership_tier || "—") + "</span></div>" +
            "<div class='detail-row'><span>Credit balance</span><span>" + (data.credit_balance ?? 0) + "</span></div>" +
            "<div class='detail-row'><span>Member points</span><span>" + (data.member_point_balance ?? 0) + "</span></div>" +
          "</div>" +
          "<div style='margin-top:0.75rem;'>" +
            "<div class='muted' style='margin-bottom:0.25rem;'>Tags</div>" +
            (tags || "<span class='muted'>No tags</span>") +
          "</div>" +
          "<div style='margin-top:0.75rem;'>" +
            "<div class='muted' style='margin-bottom:0.25rem;'>Coupons</div>" +
            (coupons ? "<ul style='margin:0;padding-left:1.1rem;font-size:0.85rem;'>" + coupons + "</ul>" : "<span class='muted'>No coupons</span>") +
          "</div>";
      }

      function attachHandlers() {
        const links = document.querySelectorAll(".customer-name-link[data-customer-id]");
        links.forEach(function (el) {
          el.addEventListener("click", function (e) {
            e.preventDefault();
            const cid = el.getAttribute("data-customer-id");
            if (!cid) return;
            backdrop.style.display = "block";
            body.textContent = "Loading…";
            title.textContent = "Member";
            fetch("/portal/customers/" + encodeURIComponent(cid) + "/quick-view/")
              .then(function (r) { return r.json(); })
              .then(renderContent)
              .catch(function () {
                body.innerHTML = "<p style='color:#b91c1c;'>Failed to load member info.</p>";
              });
          });
        });
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", attachHandlers);
      } else {
        attachHandlers();
      }
    })();
  </script>
</body>
</html>
